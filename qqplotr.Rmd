---
title: ggplot2 compatible Quantile-quantile plots in R
author:
  - name: Alexandre Almeida
    affiliation: University of Campinas
    address:
    - Institute of Computing
    - Campinas, Brazil 13083-852
    email:  almeida.xan@gmail.com
  - name: Adam Loy
    affiliation: Carleton College
    address:
    - Department of Mathematics and Statistics
    - Northfield, MN 55057
    email:  aloy@carleton.edu
  - name: Heike Hofmann
    affiliation: Iowa State University
    address:
    - Department of Statistics
    - Ames, IA 50011-1210
    email:  hofmann@iastate.edu
abstract: >
  An abstract of less than 150 words.
preamble: >
  % Any extra latex you need in the preamble
  \usepackage{nameref}
  \usepackage{color}
output: rticles::rjournal_article
---

\newcommand{\hh}[1]{{\textcolor{orange}{#1}}}

## TODO:

* Abstract
* Conclusion

## Introduction
\label{sec:introduction}

Univariate distributional assessment is a common thread throughout statistical analyses during both the exploratory and confirmatory stages. When we begin exploring a new data set we often consider the distribution of individual variables before moving on to explore multivariate relationships. After a model has been fit to a data set, we must assess whether the distributional assumptions made are reasonable, and if they are not, then we must understand the impact this has on the conclusions of the model. Graphics provide arguably the most common way to carry out these univariate assessments. While there are many plots that can be used for distribution exploration and assessment, a quantile-quantile (Q-Q) plot \citep{Wilk1968-ii} is one of the most common plots used. 

Q-Q plots compare two distributions by matching a commmon set of quantiles. 
<!-- For two samples of size $n$, $X_1, X_2, \ldots, X_n$ and $Y_1, Y_2, \ldots, Y_n$, a Q-Q plot is a scatterplot comparing the sample quantiles.  -->
To compare a sample, $y_1, y_2, \ldots, y_n$ to a theoretical distribution, a Q-Q plot is simply a scatterplot of the sample quantiles, $y_{(i)}$, against the corresponding quantiles from the theoretical distribution, $F^{-1}\left( F_n(y_i) \right)$. If the empirical distribution is consistent with the theoretical distribution, then the Q-Q plot will be linear. For example, Figure \ref{fig:ex-qq1} shows two Q-Q plots: the left plot compares a sample drawn from the lognormal distribution to the lognormal distribution, while the right plot compares a sample drawn from the lognormal distribution to the normal distribution. As expected, the lognormal Q-Q plot is approximately linear as the data and model are in agreement, while the normal Q-Q plot is curved, indicating disagreement between the data and the model.

```{r ex-qq1, echo=FALSE, out.width='.4\\linewidth', fig.width=3.5, fig.height=3.5, fig.show='hold', fig.align='center', fig.cap="The left plot compares a sample drawn from the lognormal distribution to the lognormal distribution, while the right plot compares a sample drawn from the lognormal distribution to the normal distribution. The curvature in the normal Q-Q plot highlights the disagreement betweeen the data and the model.", message = FALSE}
library(qqplotr)
set.seed(952017)
rand_sample <- data.frame(rs = rlnorm(20, meanlog = 0, sdlog = 1))

ggplot(data = rand_sample, mapping = aes(sample = rs)) +
  stat_qq_point(distribution = "lnorm") +
  ylab("Sample quantiles") +
  xlab("Theoretical quantiles") +
  ggtitle("Lognormal Q-Q plot") +
  theme_minimal()

ggplot(data = rand_sample, mapping = aes(sample = rs)) +
  stat_qq_point() +
  ylab("Sample quantiles") +
  xlab("Theoretical quantiles") +
  ggtitle("Normal Q-Q plot") +
  theme_minimal()
```

Additional graphical elements are often added to Q-Q plots in order to aid in distributional assessment. A reference line is often added to a Q-Q plot to assist the detection of departures from normality.  This line is often drawn by connecting the first and third quartiles. Pointwise or simultaneous confidence bands are also frequently built around the reference line to display the expected degree of sampling error for the proposed model, so that minor deviations from the reference line are not over-interpreted. Figure \ref{fig:ex-qq2} adds such reference lines and 95% pointwise confidence bands to the Q-Q plots in Figure \ref{fig:ex-qq1}.

```{r ex-qq2, echo=FALSE, out.width='.4\\linewidth', fig.width=3.5, fig.height=3.5, fig.show='hold', fig.align='center', fig.cap="Adding reference lines and $95\\%$ pointwise confidence bands to the Q-Q plots in Figure 1.", message = FALSE}
library(qqplotr)
set.seed(952017)
rand_sample <- data.frame(rs = rlnorm(20, meanlog = 0, sdlog = 1))

ggplot(data = rand_sample, mapping = aes(sample = rs)) +
  stat_qq_point(distribution = "lnorm") +
  stat_qq_line(distribution = "lnorm", color = "blue") +
  stat_qq_band(distribution = "lnorm", alpha = 0.5) +
  ylab("Sample quantiles") +
  xlab("Theoretical quantiles") +
  ggtitle("Lognormal Q-Q plot") +
  theme_minimal()

ggplot(data = rand_sample, mapping = aes(sample = rs)) +
  stat_qq_point() +
  stat_qq_line(color = "blue") +
  stat_qq_band(alpha = 0.5) +
  ylab("Sample quantiles") +
  xlab("Theoretical quantiles") +
  ggtitle("Normal Q-Q plot") +
  theme_minimal()
```

Different orientations of Q-Q plots have also been proposed, most notably the de-trended Q-Q plot. To detrend a Q-Q plot, the $y$-axis is changed to show the difference between the observed quantile and the reference line. Consequently, the line representing the agreement with the theoretical distribution is the $x$-axis. \citet{Loy2016-fg} find that detrended Q-Q plots are more powerful than other designs, so long as the $y$-axis limits are set so that the aspect ratio is kept the same as in the traditional Q-Q plot, which they call *adjusted de-trended Q-Q plots*. Figure \ref{fig:ex-detrend} displays the normal Q-Q plot from Figure \ref{fig:ex-qq2} along with its adjusted detrended version.

```{r ex-detrend, echo=FALSE, out.width='.4\\linewidth', fig.width=3.5, fig.height=3.5, fig.show='hold', fig.align='center', fig.cap="The left plot displays a traditional normal Q-Q plot for data simulated from a lognormal distribution. The right plot displays an adjusted detrended Q-Q plot of the same data, created by plotting the differences between the sample quantiles and the proposed model on the $y$-axis.", message = FALSE}
library(qqplotr)
set.seed(952017)
rand_sample <- data.frame(rs = rlnorm(20, meanlog = 0, sdlog = 1))

ggplot(data = rand_sample, mapping = aes(sample = rs)) +
  stat_qq_point() +
  stat_qq_line(color = "blue") +
  stat_qq_band(alpha = 0.5) +
  ylab("Sample quantiles") +
  xlab("Theoretical quantiles") +
  ggtitle("Normal Q-Q plot") +
  theme_minimal()

ggplot(data = rand_sample, mapping = aes(sample = rs)) +
  stat_qq_point(detrend = TRUE) +
  stat_qq_line(detrend = TRUE, color = "blue") +
  stat_qq_band(detrend = TRUE, alpha = 0.5) +
  ylab("Differences") +
  xlab("Theoretical quantiles") +
  ggtitle("Adjusted detrended version") +
  theme_minimal() +
  theme(aspect.ratio = 1) 
```

<!-- For Q-Q plots, a reference line is often drawn through the points $(q(.25), q_y(.25))$ and $(q(.75), q_y(.75))$. -->

<!-- If the two distributions are identical, then this scatterplot will be linear with slope 1 and intercept 0. If the two distributions differ only by a linear transformation---such as $N(0, 1)$ and $N(10, 5)$---a Q-Q plot comparing the distributions will be linear, but with a different slope and intercept. -->

<!-- Probability plotting refers to a family of methods based on the cumulative distribution function (CDF), most notably quantile (Q-Q) plots and probability (P-P) plots \citep{Wilk1968-ii}. In this paper, we focus on comparing an empirical distribution to a theoretical distribution. Let $Y_1, \ldots, Y_n$ denote a random sample from an unknown population, and let $\widehat{F}_y(q)$ be the empirical cumulative distribution obtained from the sample. Further, let $F(q)$ denote the CDF of a proposed dsitribution for the sample. A Q-Q plot is constructed by plotting the quantiles of the empirical distribution, $q_y(p) = F_y^{-1}(p)$, against the corresponding quantiles of the theoretical distribution, $q(p) = F^{-1}(p)$. This constuction is illustrated in Figure \ref{fig:qq}. -->
<!-- A P-P plot is constructed by plotting $F(q)$ against $\widehat{F}_y(q)$ for various quantiles, $q$. This constuction is illustrated in Figure \ref{fig:pp}. Regardless of the plot constructed, if the two distributions are identical, then the scatterplots will be linear with slope 1 and intercept 0. Additionally, Q-Q plots are invariant to linear transformations, so if two random variables differ by a linear transformation a Q-Q plot showing draws from their distributions will still be linear, but with a different slope and intercept, as seen in Figure \ref{fig:qq}. P-P plots, in turn, are sensitive to linear transformations. -->

<!-- Innovations to Q-Q and P-P plots have also been proposed. \citet{Loy2016-fg} discuss the creation of detrended Q-Q plots, where the $y$-axis is changed to show the difference between $q_y$ and the reference line. Consequently, the line representing the agreement with the theoretical distribution is the $x$-axis. \citet{Loy2016-fg} find that detrended Q-Q plots are more powerful than other designs, so long at the $y$-axis limits are set so that the aspect ratio is kept the same as in the traditional Q-Q plot. In reliability and survival analysis, probability plots often refer to a hybrid probability plot, there the CDF of the proposed theoretical distribution is plotted against the empirical order statistics, and transformations are applied to each axis to linearize the CDF \citep[cf.][chapter 6]{Meeker1998}. This hybrid probability plot is invariant to linear transformations. -->

Various implementations of Q-Q plots exist in R. Normal Q-Q plots, where a sample is compared to the standard normal distribution, are implemented using `qqplot` and `qqline` in \pkg{base} graphics \citep{R}. \pkg{lattice} provides a general framework for Q-Q plots in the `qqmath` function, allowing one to compare a sample to any theoretical distribution by specifying the appropriate quantile function \citep{lattice}. `qqPlot` in the \pkg{car} package also allows for the assessment of non-normal distributions and adds pointwise confidence bands via normal theory or the parametric bootstrap \citep{car}. \pkg{ggplot2} provides `geom_qq` and `geom_qq_line`, enabling the creation of Q-Q plots with a reference line, much like those created using `qqmath` \citep{ggplot2}. None of these general use packages allow for easy construction of de-trended Q-Q plots.

\pkg{qqplotr} extends \pkg{ggplot2} to provide a complete implementation of Q-Q plots. The package allows for quick construction of all Q-Q plot designs without sacrificing the flexibility of the \pkg{ggplot2} framework. In the remainder of this paper, we will introduce the plotting framework provided by \pkg{qqplotr} and provide multiple examples of how it can be used. 

<!-- XXX `qualityTools` \cite{qualityTools} -->

## Implementing probability plots in the \pkg{ggplot2} framework

With \pkg{qqplotr} we extend some of the original \pkg{ggplot2} Q-Q plot 
functionatilites by permitting the drawing of Q-Q points, lines, and confidence 
bands. Our approach provides a \pkg{ggplot2} layering mechanism so that for each
one of those plot elements we implemented a \pkg{ggplot2} "stat" (statistical 
transformation). In addition, we also implemented a \pkg{ggplot2} "geom" 
(geometrical object) specifically for the confidence bands. That geom permits a 
simpler way of handling graphical parameters, which will become clearer in the 
\nameref{sec:examples} section.

The Q-Q plot functions are divided into three statistical transformations. 
Below, we describe each one of those functions and also give an overview of its
parameters.

### `stat_qq_point`

This is a modified version of `stat_qq`/`geom_qq` from \pkg{ggplot2} that plots 
the sample quantiles versus the theoretical quantiles (as in Figure 
\ref{fig:ex-qq1}). The novelty of this implementation is an option to detrend 
the plotted points (see \nameref{sec:introduction}). Note that all other 
implemented functions in the \pkg{qqplotr} package also allow for this option.
Below we present a complete call to `stat_qq_point` and highlight its default
parameters values:

```{r echo=TRUE, eval=FALSE}
stat_qq_point(
  data = NULL,
  mapping = NULL,
  geom = "point",
  position = "identity",
  na.rm = TRUE,
  show.legend = NA,
  inherit.aes = TRUE,
  distribution = "norm",
  dparams = list(),
  detrend = FALSE,
  qtype = 7,
  qprobs = c(0.25, 0.75),
  ...
  )
```

* Parameters such as `data`, `mapping`, `geom`, `position`, `na.rm`, 
`show.legend`, and `inherit.aes` are specific for \pkg{ggplot2} implementations.

* `distribution` is a character string that sets the theoretical probability 
distribution. Here, we followed the nomenclature from the \pkg{stats} package. 
You must not provide the full distribution function name (e.g., `"dnorm"`). 
Instead, just provide its suffix (e.g., `"norm"`). If you wish to provide a
custom distribution (as we will do in Section \ref{sec:user-dists}), you may do
so by first creating the density (PDF), distribution (CDF), quantile, and random
functions (also by following \pkg{stats} package nomenclature, i.e., for
`"custom"`, you must first create the `dcustom`, `pcustom`, `qcustom`, and 
`rcustom` functions).

* `dparams` is a named list to be provided alongside with the previously chosen 
`distribution`. By default, MLEs are used for the distributional parameters. By
manually providing any of the distributional parameters, the MLE is
automatically turned off. Please note that MLEs are currently only supported for
common distributions (i.e., those from the \pkg{stats} package); so if you do
provide a custom distribution to `distribution`, be sure to provide *all* of its
parameters to `dparams`.

* `detrend` is a boolean that controls whether the points should be detrended (as 
shown in Figure \ref{fig:ex-detrend}). More on that in Section
\ref{sec:detrending}.

* `qtype` and `qprobs` are only used when `detrend = TRUE`. These parameters are
passed on to the `type` and `probs` parameters of `quantile` function from the
\pkg{stats} package. The `quantile` function is used to define the quantiles
where the reference line (i.e., the proposed model) shall intercept.

### `stat_qq_line`

This statistical transformation draws a reference line based on the sample data 
quantiles. Note that the `stat_qq_line` call below does not present any 
additional parameters when compared to `stat_qq_point`.

```{r echo=TRUE, eval=FALSE}
stat_qq_line(
  data = NULL,
  mapping = NULL,
  geom = "path",
  position = "identity",
  na.rm = TRUE,
  show.legend = NA,
  inherit.aes = TRUE,
  distribution = "norm",
  dparams = list(),
  detrend = FALSE,
  qtype = 7,
  qprobs = c(0.25, 0.75),
  ...
  )
```

### `stat_qq_band`

Draws confidence bands around the reference line using one of three methods: a 
normal approximation, the parametric bootstrap, or the tail-sensitive procedure.
Below, we present the call to `stat_qq_band` and describe its specific 
parameters:

```{r echo=TRUE, eval=FALSE}
stat_qq_band(
  data = NULL,
  mapping = NULL,
  geom = "qq_band",
  position = "identity",
  show.legend = NA,
  inherit.aes = TRUE,
  na.rm = TRUE,
  distribution = "norm",
  dparams = list(),
  detrend = FALSE,
  qtype = 7,
  qprobs = c(0.25, 0.75),
  bandType = "normal",
  B = 1000,
  conf = 0.95,
  mu = NULL,
  sigma = NULL,
  ...
  )
```

* `bandType` is a character string that controls the method to be used when
constructing the confidence bands:
    + **Normal:** Specifying `bandType = "normal"` constructs pointwise confidence
bands based on the normal approximation to the distribution of the order
statistics. For example, an approximate 95\% confidence interval for the $i$th
order statistic is $\widehat{X}_{(i)}~\pm~\Phi^{-1}(.975)~\cdot~SE(X_{(i)})$,
where $\widehat{X}_{(i)}$ denotes the value along the fitted line,
$\Phi^{-1}(\cdot)$ denotes the quantile function for the standard normal
distribution, and $SE(X_{(i)})$ is the standard error of the $i$th order
statistic.
    + **Bootstrap:** Specifying `bandType = "bs"` constructs pointwise confidence 
bands using percentile confidence intervals from the parametric bootstrap.
    + **Tail-sensitive:** Specifying `bandType = "ts"` constructs the simulation-based
tail-sensitive simultaneous confidence bands proposed by
\citet{Aldor-Noiman2013-xw}.

* `B` is an integer that represents the number of bootstrap replicates (if
`bandType = "bs"`) or the number of simulated samples (if `bandType = "ts"`).

* `conf` is a numerical variable that controls the confidence level of the bands,
which must be a value between 0 and 1.

* `mu` and `sigma` are only used when `bandType = "ts"`. They represent the 
center and scale distributional parameters, respectively, which are used used to
construct the simulated tail-sensitive confidence bands. If any of the
parameters is provided with `NULL`, then both the center and scale parameters
will be estimated using robust estimates via the `robustbase` package.

\FloatBarrier

## Examples
\label{sec:examples}

In this section, we demonstrate the capabilities of the \pkg{qqplotr} package. We start by loading
the package:

```{r message=FALSE}
# also loads ggplot2
library(qqplotr)
```

### BRFSS example

The Center for Disease Control and Prevention runs an annual telephone survey, the Behavioral Risk Factor Surveillance System (BRFSS), to keep track of the US populations' 'health-related risk behaviors, chronic health conditions, and use of preventive services'.  

Close to half a million interviews are conducted each year. Here, we are focussing on the 2012 responses for Iowa. 7166 responses were gathered across 359 questions and derived variables. Among these, are people's height and weight, which we are going to assess in more detail. 

Figure \ref{fig:heights} shows two Q-Q plots side by side. For each of the plots, a sample of 200 men and 200 women is drawn from the overall number of responses. On the left hand side, individuals' heights are plotted in a Q-Q plot comparing raw heights to a normal distribution. We see that the distributions for both men and women (colour) is showing horizontal steps: this indicates that the distributional assessement is heavily dominated by the discreteness in the data, as most survey participants responded to the question of their height to the closest inch. On the right hand side of Figure \ref{fig:heights}, we use jittering; this means  that we add a random number generated from a random uniform distribution on $\pm 0.5$ inch to the reported height. By this mean we diminish the effect that discreteness might have on the distribution. This brings the observed distribution much closer to a normal distribution. Note that separate normal distributions were fitted for each gender, not surprisingly, the resulting distributions have different means (women are on average 6 inch shorter than men in this dataset). Interestingly, the slope of the two genders is similar, indicating that the same scale parameter fits both genders' distributions (the standard deviation of height in the data set is 2.97 inch for men and 2.91 inch for women, see Table \ref{tab:heights}). 
The dark line between the two groups is the identity line - indicating the theoretical distribution each of these groups are compared to. This distribution is based on parameters estimated from the whole population (see Table \ref{tab:heights} for numbers) . While the mean is about half way between the gender means, we see from the higher slope of the line that in comparison to each group, the standard deviation of the height based on the whole population is larger.


```{r iowa-read, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)

iowa <- readRDS("data/brfss-iowa.rda")
set.seed(3145)
sub <- iowa %>% nest(-SEX) %>% mutate(
  data = data %>% purrr::map(.f = function(x) sample_n(x, size = 200))  
) %>% unnest(data) %>% dplyr::select(SEX, WTKG3, HTIN4) %>%
  mutate(Gender = c("Male", "Female")[SEX])

params <- iowa %>% filter(!is.na(HTIN4)) %>% summarize(
  m = mean(HTIN4),
  s = sd(HTIN4)
)
p1 <- sub %>% ggplot(aes(sample = HTIN4, colour=Gender, fill=Gender)) + 
#  geom_abline(slope=1, intercept=0, colour = "grey30") +
  stat_qq_band(alpha = 0.3, dparams=list(mean=params$m, sd=params$s)) + 
  stat_qq_line( dparams=list(mean=params$m, sd=params$s)) + 
  stat_qq_point( dparams=list(mean=params$m, sd=params$s)) +
  scale_fill_brewer(palette="Set1") +
  scale_colour_brewer(palette = "Set1") +
  xlab("Theoretical quantiles") +
  ylab("Height (in inch)") +
  coord_equal() +
  theme_bw() +
  theme(legend.position = c(0.8, 0.2), aspect.ratio = 1)

p2 <- sub %>% mutate(
  HTIN4.jitter = jitter(HTIN4, factor = 2)
) %>% ggplot(aes(sample = HTIN4.jitter, colour=Gender, fill=Gender)) + 
  geom_abline(slope=1, intercept=0, colour = "grey40") +
  stat_qq_band(alpha = 0.3, dparams = list(mean=params$m, sd=params$s)) +
  stat_qq_line(dparams = list(mean=params$m, sd=params$s)) + 
  stat_qq_point(dparams = list(mean=params$m, sd=params$s)) +
  scale_fill_brewer(palette="Set1") +
  scale_colour_brewer(palette = "Set1") +
  xlab("Theoretical quantiles") +
  ylab("Jittered Height (in inch)") +
  theme_bw() + 
  theme(legend.position = c(0.8, 0.2), aspect.ratio=1)
```

```{r heights-table, echo=FALSE, results="asis"}
bygender <- iowa %>% group_by(SEX) %>%
  summarize(
    mean = mean(HTIN4, na.rm=TRUE),
    sd = sd(HTIN4, na.rm=TRUE)
  )
bygender$SEX <- c("Male", "Female")

total <- iowa %>% 
  summarize(
    mean = mean(HTIN4, na.rm=TRUE),
    sd = sd(HTIN4, na.rm=TRUE)
  )

bygender[3,] <- c("Total", total)
knitr::kable(bygender, format = "latex",  
             caption = "Summary of Iowa's residents height and standard deviation (in inch) by gender and total.\\label{tab:heights}", 
             digits=2, booktabs = TRUE)
```

```{r heights, echo=FALSE, fig.width = 8, fig.height = 3.5, fig.cap = "Sample (200 men and 200 women) of raw heights (left) and jittered heights (right). The distribution on the left is dominated by the discreteness of the data. On the right we see that except for some outliers an assumption of normality for people's height is not completely absurd.", out.width='\\textwidth', fig.align="center", message=FALSE, warning = FALSE}
library(gridExtra)  
grid.arrange(p1, p2, ncol = 2)
```

Unlike respondents' heights, their weigths do not seem to be normally distributed. Figure \ref{fig:weights} shows again two Q-Q plots. The Q-Q plot on the left uses raw weights and compares to a normal distribution. From the curved points we see that tails of the observed distribution are heavier than expected under a normal distribution. On the right, weights are log-transformed. We see that a normal distribution for each of the genders shows --with the exceptions of a few extreme outliers-- a reasonable fit.

```{r weights, echo=FALSE, fig.width = 8, fig.height = 3.5, fig.cap = "Sample (200 men and 200 women) of weights. Unlike people's height, weight seems to be heavily right skewed with some additional outliers on the extreme left (left plot). On the right, weight was log-transfomed before its distribution is compared to a theoretical normal. ", out.width='\\textwidth', fig.align="center", message=FALSE, warning = FALSE}
params <- iowa %>% filter(!is.na(WTKG3)) %>% summarize(
  m = mean(WTKG3/100),
  s = sd(WTKG3/100)
)
p3 <- sub %>% ggplot(aes(sample = WTKG3/100, colour=Gender, fill=Gender)) + 
  stat_qq_band(alpha = 0.3, dparams=list(mean=params$m, sd=params$s)) + 
  stat_qq_line( dparams=list(mean=params$m, sd=params$s)) + 
  stat_qq_point( dparams=list(mean=params$m, sd=params$s)) +
  scale_fill_brewer(palette="Set1") +
  scale_colour_brewer(palette = "Set1") +
  xlab("Theoretical quantiles") +
  ylab("Weight (in kg)") +
  coord_equal() +
  theme_bw() +
  theme(legend.position = c(0.8, 0.2), aspect.ratio = 1)

p5 <- sub %>% 
  ggplot(aes(sample = log(WTKG3/100), colour=Gender, fill=Gender)) + 
  stat_qq_band(alpha = 0.3, dparams=list(mean=params$m, sd=params$s)) + 
  stat_qq_line( dparams=list(mean=params$m, sd=params$s)) + 
  stat_qq_point( dparams=list(mean=params$m, sd=params$s)) +
  scale_fill_brewer(palette="Set1") +
  scale_colour_brewer(palette = "Set1") +
  xlab("Theoretical quantiles") +
  ylab("log Weight (in kg)") +
  coord_equal() +
  theme_bw() +
  theme(legend.position = c(0.8, 0.2), aspect.ratio = 1)

# don't need the jittering
grid.arrange(p3, p5, ncol = 2)
```

Instead of transforming the observed values, we can change the theoretical distribution against which we compare. 
Figure \ref{fig:weights-log} shows two Q-Q plots where a log-normal distribution is chosen as the theoretical distribution. On the left, we compare against a  log-normal distribution with mean 4.389 and standard deviation 0.223 (the log-transformed averages of average weight and standard deviation in Iowa's population). Again, the fits seem reasonable. 
On the right, parameters for the log-normal distribution are fit separately. The fits are slightly different from XXX

```{r weights-log, echo=FALSE, fig.width = 8, fig.height = 3.5, fig.cap = "Sample (200 men and 200 women) of weights. On the left, the theoretical distribution  is changed to a log normal. On the right, we additionally estimate shift and scale parameters for each of the genders separately before comparing distributions to a log-normal.", out.width='\\textwidth', fig.align="center", message=FALSE, warning = FALSE}

mlog <- mean(log(sub$WTKG3 / 100), na.rm = TRUE)
sdlog <- sd(log(sub$WTKG3 / 100), na.rm = TRUE)

p4 <- sub %>% ggplot(aes(sample = WTKG3 / 100, colour = Gender, fill = Gender)) +
  stat_qq_band(
    distribution = "lnorm",
    dparams = list(meanlog = mlog, sdlog = sdlog),
    alpha = 0.3
  ) +
  stat_qq_line(
    distribution = "lnorm",
    dparams = list(meanlog = mlog, sdlog = sdlog)
  ) +
  stat_qq_point(
    distribution = "lnorm",
    dparams = list(meanlog = mlog, sdlog = sdlog)
  ) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1") +
  xlab("Theoretical quantiles") +
  ylab("Weight (in kg)") +
  theme_bw() + 
  theme(legend.position = c(0.2, 0.8), aspect.ratio=1)

p6 <- sub %>% ggplot(aes(sample = WTKG3 / 100, 
                         colour = Gender, fill = Gender)) +
  stat_qq_band(distribution = "lnorm", alpha = 0.3) +
  stat_qq_line(distribution = "lnorm") +
  stat_qq_point(distribution = "lnorm") +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1") +
  xlab("Theoretical quantiles") +
  ylab("Weight (in kg)") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.8),
  aspect.ratio = 1)

grid.arrange(p4, p6, ncol = 2)
```

```{r table, echo=FALSE, results = 'asis'} 
tabs <- iowa %>% group_by(SEX) %>% summarize(
  mean_wt = mean(WTKG3 / 100, na.rm = TRUE),
  mean_log_wt = mean(log(WTKG3 / 100), na.rm = TRUE),
  sd_wt = sd(WTKG3 / 100, na.rm = TRUE),
  sd_log_wt = sd(log(WTKG3 / 100), na.rm = TRUE)#,
  # fitdistr = I(list(MASS::fitdistr(na.omit(WTKG3/100), "lognormal")))
  )

knitr::kable(tabs, format = "latex", caption = "this table is just for us at the moment")
```

### Using user-provided distributions
\label{sec:user-dists}

Using the capabilities of \pkg{qqplotr} with the distributions implemented in the \pkg{stats} package is relatively straightfoward, since the implementation allows you to specify the suffix (i.e. distribution and or abbreviation) via the `distribution` argument and the parameter estimates via `dparams` argument. However, there are times when the distributions in \pkg{stats} are not sufficient for the demands of the analysis. For example, there is no left-skewed distribution listed. User-coded distributions or distributions from other packages can be used with \pkg{qqplotr} as long as the distributions are defined following the conventions laid out in the \pkg{stats} package. Specfically, for some distribution there must be density/mass (`d` prefix), CDF (`p` prefix), quantile (`q` prefix), and simulation (`r` prefix) functions. In this section we illustrate the use of the smallest extreme value distribution (SEV).

To qualify for the Olympics in the men's long jump in 2012, athletes had to either meet/exceed the 8.1 meter standard or place in the top twelve. During the qualification events, each athlete was able to jump three times, and their best (i.e. longest) jump is treated as the result. Figure \ref{fig:jump-density} shows a density plot of the results, which are cleaerly left skewed. 

```{r jump-density, echo=FALSE, fig.width = 3.5, fig.height = 3.5, fig.cap = "Density plot of the 2012 men's long jump qualifying round. The distances are clearly left skewed.", out.width='0.45\\textwidth', fig.align="center", message=FALSE, warning = FALSE}
longjump <- na.omit(longjump)
ggplot(longjump, aes(distance)) +
  geom_density(fill = "orange", color = "orange", alpha = 0.5) +
  xlab("Jump distance (in m)") +
  theme_bw()
```

In order to model the jump distances we must first define a left-skewed distribution. Below, we define the suite of distributional functions necessary to utilize the SEV distribution.

```{r}
# CDF
psev <- function(q, mu = 0, sigma = 1) {
    z <- (q - mu) / sigma
    1 - exp(-exp(z))
}

# PDF
dsev <- function(x,  mu = 0, sigma = 1) {
  z <- (x - mu) / sigma
  (1 / sigma) * exp(z - exp(z))
}

# Quantile function
qsev <- function(p,  mu = 0, sigma = 1) {
  mu + log(-log(1 - p)) * sigma
}

# Simulation function
rsev <- function(n,  mu = 0, sigma = 1) {
  qsev(runif(n), mu, sigma)
}
```

With the `*sev` distribution functions in hand, we can create a Q-Q plot to assess the appropriateness of the SEV model (Figure \ref{fig:sev-qq}). The Q-Q plot show that the distances do not substantially deviate from the SEV model, so we have found an adequate representation of the distances.

```{r sev-qq, fig.cap = "Q-Q plot comparing the long jump distances to the standard SEV distribution. The SEV distribution appear to adequately model the distances.", fig.width = 3.5, fig.height = 3.5, out.width='0.45\\textwidth', fig.align="center", message=FALSE, warning = FALSE}
ggplot(longjump, aes(sample = distance)) +
  stat_qq_band(distribution = "sev", dparams = list(mu = 0, sigma = 1), alpha = 0.3) +
  stat_qq_line(distribution = "sev", dparams = list(mu = 0, sigma = 1)) +
  stat_qq_point(distribution = "sev", dparams = list(mu = 0, sigma = 1)) +
  xlab("Theoretical quantiles") +
  ylab("Jump distance (in m)") +
  theme_bw()
```

### Detrending Q-Q plots
\label{sec:detrending}

\pkg{qqplotr} also allows for Q-Q plots to be *detrended*. In a detrended Q-Q plot, the $y$-axis shows the difference between the empirical quantile and the reference line (i.e. the theoretical distribution). This layout directly plots what we want viewers to assess --the difference between the distributions being compared-- which \citet{Loy2016-fg} found to be more powerful than other designs, so long as the $y$-axis limits are set so that the aspect ratio is kept the same as in the traditional Q-Q plot.

For example, Figure \ref{fig:detrend-sev} compares the standard Q-Q plot shown in Figure \ref{fig:sev-qq} with a detrended version by adding the argument `detrend = TRUE` to the `stat_qq_band`, `stat_qq_line`, and `stat_qq_point` calls.

```{r detrend-sev, echo=FALSE, fig.width = 8, fig.height = 3.5, fig.cap = "Q-Q plots assessing the appropriateness of the SEV distribution for the long jump data. On the left, a standard Q-Q plot is shown. On the right, we detrend the Q-Q plot by plotting the differences between the empirical quantiles and reference line on the $y$-axis.", out.width='\\textwidth', fig.align="center", message=FALSE, warning = FALSE}
p7 <- ggplot(longjump, aes(sample = distance)) +
  stat_qq_band(distribution = "sev", alpha = 0.3, dparams = list(mu = 0, sigma = 1)) +
  stat_qq_line(distribution = "sev", dparams = list(mu = 0, sigma = 1)) +
  stat_qq_point(distribution = "sev", dparams = list(mu = 0, sigma = 1)) +
  xlab("Theoretical quantiles") +
  ylab("Jump distance (in m)") +
  theme_bw()

p8 <- ggplot(longjump, aes(sample = distance)) +
  stat_qq_band(distribution = "sev", alpha = 0.3, detrend = TRUE, dparams = list(mu = 0, sigma = 1)) +
  stat_qq_line(distribution = "sev", detrend = TRUE, dparams = list(mu = 0, sigma = 1)) +
  stat_qq_point(distribution = "sev", detrend = TRUE, dparams = list(mu = 0, sigma = 1)) +
  xlab("Theoretical quantiles") +
  ylab("Differences") +
  theme_bw() +
  theme(aspect.ratio=1)

grid.arrange(p7, p8, ncol = 2)
```

```{r eval=FALSE}
ggplot(longjump, aes(sample = distance)) +
  stat_qq_band(
  distribution = "sev",
  alpha = 0.3,
  detrend = TRUE,
  dparams = c(mu = 0, sigma = 1)
  ) +
  stat_qq_line(
  distribution = "sev",
  detrend = TRUE,
  dparams = c(mu = 0, sigma = 1)
  ) +
  stat_qq_point(
  distribution = "sev",
  detrend = TRUE,
  dparams = c(mu = 0, sigma = 1)
  ) +
  xlab("Theoretical quantiles") +
  ylab("Differences") +
  theme_bw() +
  theme(aspect.ratio = 1)
```

In order to create a so-called *adjusted* detrended Q-Q plot \citep{Loy2016-fg} the aspect ratio must also be set to 1. If the aspect ratio is not adjusted in this way, an *ordinary* detrended Q-Q plot is created, which is known to have lower power than the standard Q-Q plot in some situations \citep{Loy2016-fg}.



## Summary

XXX P-P plots here
Write this section once the rest of the paper is done.

```{r, echo=FALSE, out.width='.31\\linewidth', fig.width=3.5, fig.height=3.5, fig.show='hold', fig.align='center', fig.cap="\\label{fig:pp-designs}Illustrating different designs of probability plots."}
rand_sample$ppoints <- ppoints(rand_sample$rs)
ggplot(data = rand_sample, mapping = aes(x = sort(rs), y = ppoints)) +
  geom_point() +
  xlab("Sample quantiles") +
  ylab("Cumulative probabilty") +
  theme_minimal() +
  ggtitle("Hybrid probability plot")
```

\bibliography{RJreferences}

## Acknowledgements

This work was partially funded by Google Summer of Code 2017.
